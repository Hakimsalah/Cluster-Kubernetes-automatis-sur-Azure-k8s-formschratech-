pipeline {
    agent any

    environment {
        // Kubeconfig stock√© comme secret fichier dans Jenkins
        KUBECONFIG = ''
    }

    stages {

        stage('Checkout Manifests') {
            steps {
                git branch: 'main', url: 'https://github.com/Hakimsalah/Cluster-Kubernetes-automatis-sur-Azure-k8s-formschratech-.git'
            }
        }

        stage('Deploy MySQL') {
    steps {
        withCredentials([file(credentialsId: 'kubeconfig-secret', variable: 'KUBECONFIG')]) {
            sh '''
            echo "‚úÖ Creating PersistentVolumeClaim..."
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f mysql-pvc.yaml

            echo "‚è≥ Waiting for PVC to be Bound..."
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify wait pvc/mysql-pvc --for=condition=Bound --timeout=60s

            echo "‚úÖ Creating MySQL secret..."
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f mysql-secret.yaml

            echo "‚úÖ Deploying MySQL..."
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f mysql-deployment.yaml
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f mysql-service.yaml

            echo "‚è≥ Waiting for MySQL to be ready..."
            kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify rollout status deployment/mysql-deployment
            '''
        }
    }
}


        stage('Deploy Backend & Frontend') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-secret', variable: 'KUBECONFIG')]) {
                    dir('k8s-manifests') {
                        sh '''
                        echo "‚úÖ Deploying Backend..."
                        kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f backend/
                        kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify rollout status deployment/backend-deployment

                        echo "‚úÖ Deploying Frontend..."
                        kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f frontend/
                        kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify rollout status deployment/frontend-deployment
                        '''
                    }
                }
            }
        }

        stage('Deploy Ingress') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-secret', variable: 'KUBECONFIG')]) {
                    dir('k8s-manifests/ingress') {
                        sh '''
                        echo "‚úÖ Deploying Ingress..."
                        kubectl --kubeconfig=$KUBECONFIG --insecure-skip-tls-verify apply -f .
                        '''
                    }
                }
            }
        }

        stage('Verify Deployments') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-secret', variable: 'KUBECONFIG')]) {
                    sh '''
                    echo "üîé Cluster Nodes:"
                    kubectl get nodes

                    echo "üîé Pods in default namespace:"
                    kubectl get pods -n default

                    echo "üîé Services in default namespace:"
                    kubectl get svc -n default

                    echo "üîé Ingress in default namespace:"
                    kubectl get ingress -n default
                    '''
                }
            }
        }
    }
}
