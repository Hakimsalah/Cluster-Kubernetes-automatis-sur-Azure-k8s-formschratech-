pipeline {
    agent any

    environment {
        // Credentials Jenkins
        ARM_CLIENT_ID       = credentials('azure-client-id')
        ARM_CLIENT_SECRET   = credentials('azure-client-secret')
        ARM_SUBSCRIPTION_ID = credentials('azure-subscription-id')
        ARM_TENANT_ID       = credentials('azure-tenant-id')

        // Variables Terraform
        LOCATION       = "francecentral"
        RESOURCE_GROUP = "rg-k8s-formschratech"
        VNET_NAME      = "k8s-vnet"
        SUBNET_NAME    = "k8s-subnet"
        ADMIN_USERNAME = "azureuser"
        SSH_KEY_PATH   = "/home/jenkins/.ssh/id_rsa.pub"
        VM_SIZEM       = "Standard_B2s"
        VM_SIZEW       = "Standard_B2s"
    }

    stages {
        stage('Checkout Terraform') {
            steps {
                git branch: 'main', url: 'https://github.com/Hakimsalah/Cluster-Kubernetes-automatis-sur-Azure-k8s-formschratech-.git'
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('terraform') {
                    sh """
                    terraform plan
                    """
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh """
                    terraform apply 
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ Terraform apply completed successfully!"
        }
        failure {
            echo "❌ Terraform pipeline failed."
        }
    }
}
